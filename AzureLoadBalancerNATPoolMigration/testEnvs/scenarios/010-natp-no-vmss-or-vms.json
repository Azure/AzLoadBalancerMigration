{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "randomGuid": {
            "type": "string",
            "defaultValue": "[newGuid()]"
        },
        "location": {
            "type": "String"
        },
        "resourceGroupName": {
            "type": "String"
        }
    },
    "variables": {},
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-10-01",
            "name": "rgdeployment",
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "adminPassword": {
                            "type": "securestring"
                        },
                        "location": {
                            "type": "string"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Network/publicIPAddresses",
                            "apiVersion": "2022-05-01",
                            "name": "pip-01",
                            "location": "[parameters('location')]",
                            "sku": {
                                "name": "Standard",
                                "tier": "Regional"
                            },
                            "properties": {
                                "publicIPAddressVersion": "IPv4",
                                "publicIPAllocationMethod": "Static",
                                "idleTimeoutInMinutes": 4,
                                "ipTags": []
                            }
                        },
                        {
                            "type": "Microsoft.Network/publicIPAddresses",
                            "apiVersion": "2022-05-01",
                            "name": "pip-02",
                            "location": "[parameters('location')]",
                            "sku": {
                                "name": "Standard",
                                "tier": "Regional"
                            },
                            "properties": {
                                "publicIPAddressVersion": "IPv4",
                                "publicIPAllocationMethod": "Static",
                                "idleTimeoutInMinutes": 4,
                                "ipTags": []
                            }
                        },
                        {
                            "type": "Microsoft.Network/virtualNetworks",
                            "apiVersion": "2022-05-01",
                            "name": "vnet-01",
                            "location": "[parameters('location')]",
                            "dependsOn": [],
                            "properties": {
                                "addressSpace": {
                                    "addressPrefixes": [
                                        "10.0.0.0/16"
                                    ]
                                },
                                "subnets": [
                                    {
                                        "name": "subnet1",
                                        "properties": {
                                            "addressPrefix": "10.0.1.0/24",
                                            "serviceEndpoints": [],
                                            "delegations": [],
                                            "privateEndpointNetworkPolicies": "Disabled",
                                            "privateLinkServiceNetworkPolicies": "Enabled"
                                        },
                                        "type": "Microsoft.Network/virtualNetworks/subnets"
                                    }
                                ],
                                "virtualNetworkPeerings": [],
                                "enableDdosProtection": false
                            }
                        },
                        {
                            "type": "Microsoft.Network/loadBalancers",
                            "apiVersion": "2022-05-01",
                            "name": "lb-standard-01",
                            "location": "[parameters('location')]",
                            "dependsOn": [
                                "pip-01"
                            ],
                            "sku": {
                                "name": "Standard",
                                "tier": "Regional"
                            },
                            "properties": {
                                "frontendIPConfigurations": [
                                    {
                                        "name": "fe-01",
                                        "id": "[concat(resourceId('Microsoft.Network/loadBalancers', 'lb-standard-01'), '/frontendIPConfigurations/fe-01')]",
                                        "properties": {
                                            "privateIPAllocationMethod": "Dynamic",
                                            "publicIPAddress": {
                                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', 'pip-01')]"
                                            }
                                        }
                                    },
                                    {
                                        "name": "fe-02",
                                        "id": "[concat(resourceId('Microsoft.Network/loadBalancers', 'lb-standard-01'), '/frontendIPConfigurations/fe-02')]",
                                        "properties": {
                                            "privateIPAllocationMethod": "Dynamic",
                                            "publicIPAddress": {
                                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', 'pip-02')]"
                                            }
                                        }
                                    }
                                ],
                                "backendAddressPools": [
                                    {
                                        "name": "be-01",
                                        "properties": {}
                                    }
                                ],
                                "loadBalancingRules": [
                                    {
                                        "name": "rule-01",
                                        "id": "[concat(resourceId('Microsoft.Network/loadBalancers', 'lb-standard-01'), '/loadBalancingRules/rule-01')]",
                                        "properties": {
                                            "frontendIPConfiguration": {
                                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', 'lb-standard-01'), '/frontendIPConfigurations/fe-01')]"
                                            },
                                            "frontendPort": 80,
                                            "backendPort": 80,
                                            "enableFloatingIP": false,
                                            "idleTimeoutInMinutes": 4,
                                            "protocol": "Tcp",
                                            "enableTcpReset": false,
                                            "loadDistribution": "Default",
                                            "backendAddressPool": {
                                                "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', 'lb-standard-01', 'be-01')]"
                                            },
                                            "backendAddressPools": [
                                                {
                                                    "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', 'lb-standard-01', 'be-01')]"
                                                }
                                            ],
                                            "probe": {
                                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', 'lb-standard-01'), '/probes/probe-01')]"
                                            }
                                        }
                                    }
                                ],
                                "probes": [
                                    {
                                        "name": "probe-01",
                                        "id": "[concat(resourceId('Microsoft.Network/loadBalancers', 'lb-standard-01'), '/probes/probe-01')]",
                                        "properties": {
                                            "protocol": "Tcp",
                                            "port": 80,
                                            "intervalInSeconds": 5,
                                            "numberOfProbes": 2,
                                            "probeThreshold": 1
                                        }
                                    }
                                ],
                                "inboundNatRules": [],
                                "inboundNatPools": [
                                    {
                                        "name": "natpool-01",
                                        "properties": {
                                            "frontendPortRangeStart": 9080,
                                            "frontendPortRangeEnd": 9085,
                                            "backendPort": 8080,
                                            "protocol": "Tcp",
                                            "idleTimeoutInMinutes": 4,
                                            "enableFloatingIP": false,
                                            "enableTcpReset": false,
                                            "frontendIPConfiguration": {
                                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', 'lb-standard-01'), '/frontendIPConfigurations/fe-01')]"
                                            }
                                        }
                                    },
                                    {
                                        "name": "natpool-02",
                                        "properties": {
                                            "frontendPortRangeStart": 9180,
                                            "frontendPortRangeEnd": 9185,
                                            "backendPort": 8180,
                                            "protocol": "Tcp",
                                            "idleTimeoutInMinutes": 4,
                                            "enableFloatingIP": false,
                                            "enableTcpReset": false,
                                            "frontendIPConfiguration": {
                                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', 'lb-standard-01'), '/frontendIPConfigurations/fe-01')]"
                                            }
                                        }
                                    },
                                    {
                                        "name": "natpool-03",
                                        "properties": {
                                            "frontendPortRangeStart": 9280,
                                            "frontendPortRangeEnd": 9285,
                                            "backendPort": 3389,
                                            "protocol": "Tcp",
                                            "idleTimeoutInMinutes": 4,
                                            "enableFloatingIP": false,
                                            "enableTcpReset": false,
                                            "frontendIPConfiguration": {
                                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', 'lb-standard-01'), '/frontendIPConfigurations/fe-01')]"
                                            }
                                        }
                                    }
                                ]
                            }
                        },
                        {
                            "type": "Microsoft.Storage/storageAccounts",
                            "apiVersion": "2021-06-01",
                            "name": "[concat('bootdiag',uniqueString(resourceGroup().id))]",
                            "location": "[parameters('location')]",
                            "sku": {
                                "name": "Standard_LRS"
                            },
                            "kind": "StorageV2",
                            "properties": {
                                "supportsHttpsTrafficOnly": true,
                                "networkAcls": {
                                    "bypass": "AzureServices",
                                    "virtualNetworkRules": [],
                                    "ipRules": [],
                                    "defaultAction": "Allow"
                                },
                                "accessTier": "Hot"
                            }
                        }
                    ]
                },
                "parameters": {
                    "adminPassword": {
                        "value": "[concat(uniqueString(parameters('randomGuid')),'eG59(^')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        }
    ]
}